<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sri Lanka Sales Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
header { text-align: center; margin-bottom: 20px; }
header h1 { margin: 0; font-size: 26px; color: #333; }
.card-small { display: inline-block; background:white; padding:15px 25px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px; text-align:center; }
.card-small p { margin:5px 0; font-size:16px; color:#555; }
.shipped-inputs { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
.shipped-inputs label { flex:1; background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
.shipped-inputs input { width:60px; padding:5px; border-radius:5px; border:1px solid #ccc; text-align:right; }
button { padding:10px 20px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; margin-bottom:20px; }
.chart-container { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
h3 { margin-top:0; }
</style>
</head>
<body>
<header>
<h1>ðŸ“Š Sri Lanka Sales Dashboard</h1>
</header>

<!-- Small summary card -->
<div class="card-small">
  <p id="summaryText">Total Shipped: 0 | Total Sold: 0 | Sales %: 0 | Remaining: 0</p>
</div>

<!-- Shipped Inputs -->
<div class="shipped-inputs" id="shippedInputs"></div>
<button onclick="updateSales()">Save Shipped Numbers</button>

<!-- Horizontal Bar Chart -->
<div class="chart-container">
<h3>Sold vs Shipped per Province</h3>
<canvas id="barChart"></canvas>
</div>

<script>
const provinces = ["Western","Central","Southern","Northern","Eastern","North Western","North Central","Uva","Sabaragamuwa"];
const districtToProvince = {
  "Colombo District":"Western","Gampaha District":"Western","Kalutara District":"Western",
  "Kandy District":"Central","Matale District":"Central","Nuwara Eliya District":"Central",
  "Galle District":"Southern","Matara District":"Southern","Hambantota District":"Southern",
  "Jaffna District":"Northern","Kilinochchi District":"Northern","Mannar District":"Northern","Mullaitivu District":"Northern","Vavuniya District":"Northern",
  "Batticaloa District":"Eastern","Ampara District":"Eastern","Trincomalee District":"Eastern",
  "Kurunegala District":"North Western","Puttalam District":"North Western",
  "Anuradhapura District":"North Central","Polonnaruwa District":"North Central",
  "Badulla District":"Uva","Monaragala District":"Uva",
  "Ratnapura District":"Sabaragamuwa","Kegalle District":"Sabaragamuwa"
};

let shipped = {};
let sold = {};
let scanData = [];

// Generate shipped input fields
const shippedDiv = document.getElementById('shippedInputs');
provinces.forEach(p=>{
  const label = document.createElement('label');
  label.innerHTML = `${p}: <input type="number" min="0" value="0" id="ship_${p}">`;
  shippedDiv.appendChild(label);
});

// Fetch sold data and saved shipped numbers
async function fetchData(){
  try {
    // Fetch scanned/sold data
    const res = await fetch("https://qr-tracker-worker.businesstroffice.workers.dev/locations");
    scanData = await res.json();
    sold = Object.fromEntries(provinces.map(p=>[p,0]));
    scanData.forEach(item=>{
      const prov = districtToProvince[item.district];
      if(prov) sold[prov]++;
    });

    // Fetch shipped numbers from KV Worker
    const shippedRes = await fetch("https://your-worker-url.workers.dev");
    shipped = await shippedRes.json();

    // Populate input fields
    provinces.forEach(p=>{
      if(shipped[p]!==undefined){
        document.getElementById(`ship_${p}`).value = shipped[p];
      }
    });

    updateSales();

  } catch(err){
    console.error(err);
  }
}

// Update summary and chart
let barChart = null;
function updateSales(){
  // Read shipped input
  provinces.forEach(p=>{
    shipped[p] = parseInt(document.getElementById(`ship_${p}`).value)||0;
  });

  const totalShipped = Object.values(shipped).reduce((a,b)=>a+b,0);
  const totalSold = Object.values(sold).reduce((a,b)=>a+b,0);
  const percent = totalShipped ? ((totalSold/totalShipped)*100).toFixed(1) : 0;

  document.getElementById("summaryText").innerText = 
    `Total Shipped: ${totalShipped} | Total Sold: ${totalSold} | Sales %: ${percent}% | Remaining: ${totalShipped-totalSold}`;

  // Save shipped numbers to KV via Worker
  fetch("https://your-worker-url.workers.dev", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(shipped)
  })
  .then(res=>res.json())
  .then(data=>console.log("Saved:", data))
  .catch(err=>console.error("Failed to save:",err));

  // Update chart
  const ctx = document.getElementById("barChart").getContext("2d");
  if(barChart) barChart.destroy();
  barChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels: provinces,
      datasets:[
        { label:'Shipped', data: provinces.map(p=>shipped[p]), backgroundColor:'#42a5f5' },
        { label:'Sold', data: provinces.map(p=>sold[p]), backgroundColor:'#66bb6a' }
      ]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      plugins:{ legend:{ position:'top' } },
      scales:{ x:{ beginAtZero:true } }
    }
  });
}

fetchData();
</script>
</body>
</html>
