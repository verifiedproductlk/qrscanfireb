<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sri Lanka Sales Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Reset & base */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#fdfbfb,#ebedee); padding:20px; color:#333; }

/* Header */
header { text-align:center; margin-bottom:30px; }
header h1 { font-size:2rem; color:#1e3c72; background:linear-gradient(to right,#2a5298,#1e3c72); -webkit-background-clip:text; color:transparent; font-weight:800; }

/* Summary Card */
.card-small { display:flex; justify-content:center; align-items:center; background:white; padding:15px 25px; border-radius:20px; box-shadow:0 8px 20px rgba(0,0,0,0.15); margin-bottom:30px; font-weight:600; font-size:16px; color:#1e3c72; }

/* Button */
button { padding:12px 25px; border:none; border-radius:30px; background:linear-gradient(45deg,#36d1dc,#5b86e5); color:white; cursor:pointer; font-weight:600; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.2); transition:0.3s; }
button:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.25); }

/* Province container */
.province-container { margin-bottom:15px; background:white; border-radius:15px; box-shadow:0 6px 20px rgba(0,0,0,0.1); overflow:hidden; transition:0.3s; }
.province-header { cursor:pointer; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:1.1rem; background:#f0f4f8; color:#1e3c72; transition:0.3s; }
.province-header:hover { background:#dde6f0; }
.province-total { padding:10px 20px; font-weight:600; color:#36d1dc; font-size:0.95rem; background:#f9faff; }
.districts { display:none; padding:10px 20px; border-top:1px solid #eee; }

.districts label { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; font-size:0.9rem; color:#555; }
.districts input { width:70px; padding:5px 8px; border-radius:8px; border:1px solid #ccc; text-align:right; transition:0.2s; }
.districts input:focus { border-color:#36d1dc; box-shadow:0 0 8px rgba(54,209,220,0.3); outline:none; }

/* Chart Container */
.chart-container { background:white; padding:20px; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.1); margin-top:20px; }

/* Responsive */
@media(max-width:768px){ 
  .districts input { width:50px; } 
  .card-small { font-size:14px; padding:12px 18px; } 
  header h1 { font-size:1.5rem; } 
}
</style>
</head>
<body>

<header>
<h1>ðŸ“Š Sri Lanka Sales Dashboard</h1>
</header>

<div class="card-small">
  <p id="summaryText">Total Shipped: 0 | Total Sold: 0 | Sales %: 0 | Remaining: 0</p>
</div>

<div id="provinceInputs"></div>
<button onclick="updateSales()">ðŸ’¾ Save Shipped Numbers</button>

<div class="chart-container">
<h3 style="color:#1e3c72;">ðŸ“ˆ Sold vs Shipped per Province</h3>
<canvas id="barChart"></canvas>
</div>

<script>
const workerURL = "https://shipped-dashboard-worker.businesstroffice.workers.dev/"; // âœ… Correct Worker URL

const provinces = ["Western","Central","Southern","Northern","Eastern","North Western","North Central","Uva","Sabaragamuwa"];
const districts = {
  "Western":["Colombo District","Gampaha District","Kalutara District"],
  "Central":["Kandy District","Matale District","Nuwara Eliya District"],
  "Southern":["Galle District","Matara District","Hambantota District"],
  "Northern":["Jaffna District","Kilinochchi District","Mannar District","Mullaitivu District","Vavuniya District"],
  "Eastern":["Batticaloa District","Ampara District","Trincomalee District"],
  "North Western":["Kurunegala District","Puttalam District"],
  "North Central":["Anuradhapura District","Polonnaruwa District"],
  "Uva":["Badulla District","Monaragala District"],
  "Sabaragamuwa":["Ratnapura District","Kegalle District"]
};

let shipped = {};
let sold = {};
let scanData = [];
let barChart = null;

const provinceDiv = document.getElementById('provinceInputs');

// Generate province + district input fields
provinces.forEach(p=>{
  const container = document.createElement('div');
  container.className = 'province-container';

  const header = document.createElement('div');
  header.className = 'province-header';
  header.innerHTML = `<span>${p}</span> <span>â–¼</span>`;
  container.appendChild(header);

  const totalDiv = document.createElement('div');
  totalDiv.className = 'province-total';
  totalDiv.id = `total_${p}`;
  totalDiv.innerText = 'Total Shipped: 0';
  container.appendChild(totalDiv);

  const districtDiv = document.createElement('div');
  districtDiv.className = 'districts';

  districts[p].forEach(d=>{
    const label = document.createElement('label');
    label.innerHTML = `${d}: <input type="number" min="0" value="0" id="ship_${d}">`;
    districtDiv.appendChild(label);

    const input = label.querySelector('input');
    input.addEventListener('input', ()=>{
      updateProvinceTotal(p);
      updateSales(false); // avoid auto-saving on every input
    });
  });

  container.appendChild(districtDiv);
  provinceDiv.appendChild(container);

  header.addEventListener('click', ()=>{
    document.querySelectorAll('.districts').forEach(dd=>dd.style.display='none');
    districtDiv.style.display = 'block';
  });
});

function updateProvinceTotal(province){
  const total = districts[province].reduce((sum,d)=>{
    const val = parseInt(document.getElementById(`ship_${d}`).value)||0;
    return sum+val;
  },0);
  document.getElementById(`total_${province}`).innerText = `Total Shipped: ${total}`;
}

async function fetchData(){
  try{
    // Fetch sold numbers from QR scanner JSON
    const res = await fetch("https://qr-tracker-worker.businesstroffice.workers.dev/locations");
    scanData = await res.json();
    sold = {};
    provinces.forEach(p=>{ districts[p].forEach(d=>sold[d]=0); });
    scanData.forEach(item=>{
      if(sold[item.district]!==undefined) sold[item.district]++;
    });

    // Fetch shipped numbers from KV
    const shippedRes = await fetch(workerURL);
    shipped = await shippedRes.json();

    Object.keys(shipped).forEach(d=>{
      const input = document.getElementById(`ship_${d}`);
      if(input) input.value = shipped[d];
    });

    provinces.forEach(p=>updateProvinceTotal(p));
    updateSales(false);
  }catch(err){ console.error(err); }
}

async function updateSales(save=true){
  // Read district shipped numbers
  shipped = {};
  provinces.forEach(p=>{
    districts[p].forEach(d=>{
      shipped[d] = parseInt(document.getElementById(`ship_${d}`).value)||0;
    });
  });

  // Aggregate per province
  const shippedPerProvince = {};
  const soldPerProvince = {};
  provinces.forEach(p=>{
    shippedPerProvince[p] = districts[p].reduce((sum,d)=>sum+shipped[d],0);
    soldPerProvince[p] = districts[p].reduce((sum,d)=>sum+sold[d],0);
  });

  const totalShipped = Object.values(shippedPerProvince).reduce((a,b)=>a+b,0);
  const totalSold = Object.values(soldPerProvince).reduce((a,b)=>a+b,0);
  const percent = totalShipped ? ((totalSold/totalShipped)*100).toFixed(1) : 0;

  document.getElementById("summaryText").innerText = 
    `Total Shipped: ${totalShipped} | Total Sold: ${totalSold} | Sales %: ${percent}% | Remaining: ${totalShipped-totalSold}`;

  // Save to KV if requested
  if(save){
    try{
      const res = await fetch(workerURL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(shipped)
      });
      const data = await res.json();
      if(!data.ok) alert("Error saving shipped numbers: "+data.error);
      else console.log("Shipped numbers saved successfully");
    }catch(err){
      alert("Failed to save shipped numbers: "+err);
    }
  }

  // Update horizontal bar chart
  const ctx = document.getElementById("barChart").getContext("2d");
  if(barChart) barChart.destroy();
  barChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels: provinces,
      datasets:[
        {label:'Shipped', data: provinces.map(p=>shippedPerProvince[p]), backgroundColor:'#36d1dc'},
        {label:'Sold', data: provinces.map(p=>soldPerProvince[p]), backgroundColor:'#5b86e5'}
      ]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      plugins:{legend:{position:'top'}},
      scales:{x:{beginAtZero:true}}
    }
  });
}

// Initial fetch
fetchData();
</script>
</body>
</html>
