<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Scan Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background-color: #f5f7fa;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 350px;
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar h3 {
      margin-top: 0;
      font-weight: normal;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 10px;
    }
    .sidebar .summary-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      padding: 5px 0;
    }
    .main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    h2 {
      margin-top: 0;
      color: #34495e;
    }
    .filter {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    select, input {
      padding: 5px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background-color: #2980b9;
      color: white;
    }
    canvas {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .chart-container {
      flex: 1 1 300px;
    }
    .shipped-inputs {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .shipped-inputs label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .shipped-inputs input {
      width: 60px;
      text-align: right;
    }
    .kpi {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .kpi-card {
      flex: 1 1 150px;
      background: #3498db;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Summary</h3>
    <div class="summary-card">
      <p>Total Scans:</p>
      <h1 id="totalScans">0</h1>
    </div>
    <h3>District Summary</h3>
    <ul id="districtSummary"></ul>
  </div>
  
  <div class="main">
    <h2>Distributor Shipments</h2>
    <div class="shipped-inputs" id="shippedInputs">
      <!-- Dynamic inputs will be added here -->
    </div>
    <button onclick="updateSales()" style="margin-bottom:20px; padding: 8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer;">Update Sales</button>
    
    <div class="kpi">
      <div class="kpi-card">
        <h3>Total Shipped</h3>
        <p id="totalShipped">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Scanned</h3>
        <p id="totalScannedSales">0</p>
      </div>
      <div class="kpi-card">
        <h3>Overall Sales %</h3>
        <p id="overallSales">0%</p>
      </div>
    </div>
    
    <div class="charts">
      <div class="chart-container">
        <canvas id="salesChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="districtChart"></canvas>
      </div>
    </div>
    
    <h2>Scanned Data Records</h2>
    <label class="filter">
      Filter by District:
      <select id="districtFilter">
        <option value="">All</option>
      </select>
    </label>
    
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Track Key</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>District</th>
          <th>Country</th>
        </tr>
      </thead>
      <tbody id="recordsTable"></tbody>
    </table>
  </div>

  <script>
    const API_URL = "https://qr-tracker-worker.businesstroffice.workers.dev/locations";
    const NOMINATIM_URL = "https://nominatim.openstreetmap.org/reverse?format=json&lat={lat}&lon={lon}&zoom=10&addressdetails=1";

    const tableBody = document.getElementById('recordsTable');
    const districtFilter = document.getElementById('districtFilter');
    const totalScans = document.getElementById('totalScans');
    const districtSummary = document.getElementById('districtSummary');

    const shippedInputsDiv = document.getElementById('shippedInputs');
    const totalShippedEl = document.getElementById('totalShipped');
    const totalScannedSalesEl = document.getElementById('totalScannedSales');
    const overallSalesEl = document.getElementById('overallSales');

    let scans = [];
    let shippedProducts = {};
    let salesChart, districtChart;

    // List of 10 provinces
    const provinces = ["Central", "Eastern", "Northern", "North Western", "North Central", "Sabaragamuwa", "Southern", "Uva", "Western", "Unknown"];

    // Generate input fields for shipped products
    function generateShippedInputs() {
      shippedInputsDiv.innerHTML = "";
      provinces.forEach(prov => {
        const label = document.createElement('label');
        label.innerHTML = `${prov}: <input type="number" min="0" value="0" id="ship_${prov}">`;
        shippedInputsDiv.appendChild(label);
      });
    }

    generateShippedInputs();

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        scans = await res.json();

        // Reverse geocoding
        await Promise.all(scans.map(async s => {
          if (s.latitude && s.longitude) {
            try {
              const url = NOMINATIM_URL.replace("{lat}", s.latitude).replace("{lon}", s.longitude);
              const geoRes = await fetch(url, { headers: { "User-Agent": "QR-Dashboard/1.0" } });
              const geoData = await geoRes.json();
              s.district = geoData.address?.county || geoData.address?.state_district || geoData.address?.state || "Unknown";
              s.country = geoData.address?.country || "Unknown";
            } catch {
              s.district = "Unknown";
              s.country = "Unknown";
            }
          }
        }));

        updateSummary();
        renderTable();
        renderCharts();
      } catch (err) {
        console.error("Error fetching data:", err);
      }
    }

    function renderTable(filter = "") {
      tableBody.innerHTML = "";
      const filtered = scans.filter(s => !filter || s.district === filter);
      filtered.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${record.timestamp || ""}</td>
          <td>${record.track_key || ""}</td>
          <td>${record.latitude || ""}</td>
          <td>${record.longitude || ""}</td>
          <td>${record.district || ""}</td>
          <td>${record.country || ""}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateSummary() {
      totalScans.textContent = scans.length;

      const counts = {};
      scans.forEach(s => {
        const d = s.district || "Unknown";
        counts[d] = (counts[d] || 0) + 1;
      });

      districtSummary.innerHTML = "";
      Object.entries(counts).forEach(([district, count]) => {
        const li = document.createElement('li');
        li.textContent = `${district}: ${count}`;
        districtSummary.appendChild(li);
      });

      // Populate filter
      districtFilter.innerHTML = `<option value="">All</option>`;
      Object.keys(counts).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        districtFilter.appendChild(opt);
      });
    }

    districtFilter.addEventListener('change', () => {
      renderTable(districtFilter.value);
      renderCharts(districtFilter.value);
    });

    function updateSales() {
      // Read shipped quantities
      shippedProducts = {};
      let totalShipped = 0;
      provinces.forEach(p => {
        const val = parseInt(document.getElementById(`ship_${p}`).value) || 0;
        shippedProducts[p] = val;
        totalShipped += val;
      });

      // Count scanned per province
      const scannedCounts = {};
      provinces.forEach(p => scannedCounts[p] = 0);
      scans.forEach(s => {
        const d = s.district || "Unknown";
        if (scannedCounts[d] !== undefined) scannedCounts[d]++;
      });

      const totalScanned = Object.values(scannedCounts).reduce((a,b)=>a+b,0);
      const overallPercent = totalShipped ? ((totalScanned/totalShipped)*100).toFixed(1) : 0;

      totalShippedEl.textContent = totalShipped;
      totalScannedSalesEl.textContent = totalScanned;
      overallSalesEl.textContent = overallPercent + "%";

      renderSalesChart(scannedCounts);
    }

    function renderSalesChart(scannedCounts) {
      const salesPercentages = provinces.map(p => {
        const shipped = shippedProducts[p] || 0;
        const scanned = scannedCounts[p] || 0;
        return shipped ? ((scanned/shipped)*100).toFixed(1) : 0;
      });

      if (salesChart) salesChart.destroy();
      const ctx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: provinces,
          datasets: [{
            label: 'Sales %',
            data: salesPercentages,
            backgroundColor: '#27ae60'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Sales %' } }
          }
        }
      });
    }

    function renderCharts(filter = "") {
      // District chart
      const filtered = scans.filter(s => !filter || s.district === filter);
      const districtCounts = {};
      filtered.forEach(s => {
        const d = s.district || "Unknown";
        districtCounts[d] = (districtCounts[d] || 0) + 1;
      });

      const labels = Object.keys(districtCounts);
      const data = Object.values(districtCounts);

      if (districtChart) districtChart.destroy();
      const ctx2 = document.getElementById('districtChart').getContext('2d');
      districtChart = new Chart(ctx2, {
        type: 'bar',
        data: { labels, datasets: [{ label:'Scans by District', data, backgroundColor:'#3498db' }] },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });
    }

    fetchData();
  </script>
</body>
</html>
